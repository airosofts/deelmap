# Buyer Portal User ID Mapping

## How User IDs Work

The buyer portal uses a **dual ID system** to bridge between the marketplace users and the conversations system:

### Two User ID Types

1. **UUID (users table)**
   - Type: `uuid` (e.g., `07e3783e-62c8-4899-88b4-d3fd8746497c`)
   - Used in: `users` table, `financing_requests.user_id`
   - Purpose: Primary identifier for marketplace users

2. **Numeric ID (conversations table)**
   - Type: `bigint` (e.g., `639941955`)
   - Used in: `conversations.user_id`, `messages.sender_id` (when sender_type='user')
   - Purpose: Identifier for chat conversations
   - **Generated by**: Hashing the user's email address

### Email Hashing Function

The numeric user ID is generated using this hash function (consistent between lender and buyer portals):

```javascript
function hashEmail(email) {
  let hash = 0;
  for (let i = 0; i < email.length; i++) {
    const char = email.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash);
}
```

**Example:**
- Email: `john@example.com`
- Hashed ID: `639941955`

## Why This Design?

This design exists because:

1. **Lender Portal** was built first and uses numeric IDs (bigint) derived from email hashing
2. **Marketplace** uses UUID for users
3. **Conversations system** was designed to work with the lender portal's numeric IDs
4. Rather than restructure the database, we use email hashing to bridge the two systems

## How It Works in the Buyer Portal

### Authentication Flow

1. User logs in via marketplace (gets UUID stored in localStorage)
2. Buyer portal API receives UUID in Authorization header
3. API looks up user in `users` table by UUID
4. API retrieves user's email
5. API hashes email to get numeric ID
6. API uses numeric ID to query `conversations` table

### Code Example

```javascript
// In /app/api/buyer/chat/route.js

async function checkBuyerAuth(request) {
  const userUuid = request.headers.get('authorization').replace('Bearer ', '');

  // Get user by UUID
  const { data: user } = await supabase
    .from('users')
    .select('id, email')
    .eq('id', userUuid)
    .single();

  // Hash email to get numeric ID for conversations
  const numericUserId = hashEmail(user.email);

  return {
    userId: numericUserId,  // For conversations queries
    userUuid: user.id       // For users table queries
  };
}
```

### Database Queries

**Fetching conversations:**
```sql
SELECT * FROM conversations
WHERE user_id = 639941955  -- Hashed email
AND is_active = true;
```

**Sending messages:**
```sql
INSERT INTO messages (conversation_id, sender_type, sender_id, message_text)
VALUES (1, 'user', 639941955, 'Hello!');  -- Hashed email
```

## Important Notes

1. **Email changes**: If a user changes their email, their numeric ID changes, and they lose access to old conversations
2. **Hash collisions**: Theoretically possible but extremely rare with this hash function
3. **Consistency**: Both lender and buyer portals MUST use the exact same hash function
4. **No schema changes needed**: This approach works with the existing database structure

## Verification

To verify the system is working correctly:

1. Check that conversations are being created with numeric user_ids
2. Ensure the same numeric ID is generated for the same email across both portals
3. Verify messages are properly attributed to users

## Future Improvements

Consider these potential improvements:

1. Add a `numeric_id` column to `users` table and store it permanently
2. Create a migration to standardize on UUIDs across all tables
3. Add a lookup table to map UUIDs to numeric IDs for backwards compatibility
